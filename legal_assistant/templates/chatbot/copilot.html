{% extends 'base.html' %}
{% block title %}Copilot Ph√°p Lu·∫≠t{% endblock %}

{% block content %}
<div class="card shadow p-3 mb-5 bg-white rounded">
    <h3 class="card-title">üß† Tr·ª£ l√Ω Copilot Ph√°p lu·∫≠t</h3>
    <div id="chatBox" class="border p-3 mb-3" style="height: 400px; overflow-y: auto; background-color: #f9f9f9;">
        <!-- Tin nh·∫Øn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
    </div>
    <div class="input-group">
        <input type="text" id="questionInput" class="form-control" placeholder="Nh·∫≠p c√¢u h·ªèi...">
        <button class="btn btn-primary" onclick="askQuestion()">G·ª≠i</button>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chatBox');
    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function askQuestion() {
        const input = document.getElementById('questionInput');
        const question = input.value.trim();
        if (!question) return;

        // Hi·ªÉn th·ªã c√¢u h·ªèi
        chatBox.innerHTML += `
            <div class="text-end mb-2">
                <span class="badge bg-primary">B·∫°n</span>
                <div class="d-inline-block bg-light p-2 rounded" style="max-width: 70%;">${question}</div>
            </div>`;
        scrollToBottom();

        // G·ª≠i ƒë·∫øn API
        const res = await fetch('/chatbot/ask/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
        });
        const data = await res.json();

        // Hi·ªÉn th·ªã c√¢u tr·∫£ l·ªùi
        chatBox.innerHTML += `
            <div class="text-start mb-2">
                <span class="badge bg-success">Copilot</span>
                <div class="d-inline-block bg-white p-2 border rounded" style="max-width: 70%;">${data.answer}</div>
            </div>`;
        input.value = '';
        scrollToBottom();
    }
    <form id="upload-form" enctype="multipart/form-data" style="margin-top: 20px;">
    <label for="contract-file">üìÑ T·∫£i l√™n h·ª£p ƒë·ªìng c·∫ßn ki·ªÉm tra:</label><br>
    <input type="file" id="contract-file" name="file" accept=".pdf,.doc,.docx" required>
    <button type="submit">üîç Ki·ªÉm tra h·ª£p ƒë·ªìng</button>
</form>

<script>
    document.getElementById("upload-form").addEventListener("submit", function(e) {
        e.preventDefault();

        const fileInput = document.getElementById("contract-file");
        const file = fileInput.files[0];

        if (!file) {
            alert("Vui l√≤ng ch·ªçn m·ªôt t·ªáp h·ª£p ƒë·ªìng.");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        fetch("/api/check_contract", {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            appendMessage("Copilot", data.result || "ƒê√£ x·ª≠ l√Ω h·ª£p ƒë·ªìng.");
        })
        .catch(err => {
            console.error(err);
            appendMessage("Copilot", "ƒê√£ c√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω h·ª£p ƒë·ªìng.");
        });
    });
</script>

</script>
{% endblock %}
<a href="https://t.me/TEN_BOT_CUA_BAN" target="_blank">
    <button style="background-color:#0088cc; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        üöÄ M·ªü Telegram Bot
    </button>
</a>
